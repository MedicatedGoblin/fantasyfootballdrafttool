<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantasy Draft Tool</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .controls {
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 8px;
      border: 1px solid black;
      text-align: left;
      vertical-align: middle;
      position: relative;
    }
    .RB { background-color: #c8f7c5; color: black; }
    .WR { background-color: #c5d9f7; color: black; }
    .QB { background-color: #f9d6a5; color: black; }
    .TE { background-color: #e3c5f7; color: black; }
    .strikethrough {
      text-decoration: line-through;
      opacity: 0.5;
      font-weight: bold;
    }
    .highlight {
      background-color: yellow !important;
    }
    .recent-pick {
      border: 3px solid orange;
      background-color: #fff3cd !important;
    }
    /* Pick number box to the right of player name in recent pick row */
    .recent-pick .pick-number-box {
      display: inline-block;
      background: orange;
      color: black;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
      margin-left: 8px;
      vertical-align: middle;
      border: 3px solid orange;
    }
    /* Mobile-friendly pick number badge */
    .pick-badge {
      display: none;
      background: orange;
      color: black;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      margin-left: 8px;
    }
    .my-picks {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
    }
    .my-picks div {
      flex: 1;
      min-width: 150px;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .team-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .pick-label {
      width: 60px;
    }
    @media (max-width: 800px) {
      /* Hide Pick # column on smaller screens */
      th.pick-number-header,
      td.pick-number-cell {
        display: none;
      }
      /* Show pick number badge on player name cell */
      .pick-badge {
        display: inline-block;
      }
      /* Hide the pick-number-box on mobile because space is limited */
      .recent-pick .pick-number-box {
        display: none;
      }
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 14px;
      }
      .controls button, .controls input, .controls select {
        font-size: 14px;
        margin-bottom: 0.5rem;
        width: 100%;
      }
      .controls {
        display: flex;
        flex-direction: column;
      }
      input[type="checkbox"] {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>

<h2>Fantasy Draft Board</h2>

<div class="controls">
  <input type="file" id="fileInput" accept=".txt" />
  <input type="text" id="searchInput" placeholder="Search players..." />
  <button onclick="filterByPosition('ALL')">ALL</button>
  <button onclick="filterByPosition('RB')">RB</button>
  <button onclick="filterByPosition('WR')">WR</button>
  <button onclick="filterByPosition('QB')">QB</button>
  <button onclick="filterByPosition('TE')">TE</button>
  <label><input type="checkbox" id="hidePickedCheckbox" onchange="renderTable()" /> Hide Picked</label>
  <button onclick="resetAll()">Reset All</button>
</div>

<div class="controls">
  <label>Number of Teams:
    <select id="teamCount"></select>
  </label>
  <div id="teamNames"></div>
  <label>Choose Your Team:
    <select id="yourTeamSelect"></select>
  </label>
  <label>Your Team Pick Number:
    <select id="myPickIndex" disabled></select>
  </label>
  <button id="startDraftBtn" onclick="setupDraft()" disabled>Start Draft</button>
  <div id="currentPickDisplay" style="margin-top: 0.5rem;"></div>
</div>

<h3>Your Picks</h3>
<div class="my-picks">
  <div><strong>QB</strong><ul id="myQB"></ul></div>
  <div><strong>RB</strong><ul id="myRB"></ul></div>
  <div><strong>WR</strong><ul id="myWR"></ul></div>
  <div><strong>TE</strong><ul id="myTE"></ul></div>
</div>

<table id="playerTable">
  <thead>
    <tr>
      <th>âœ”</th>
      <th>#</th>
      <th>Name</th>
      <th>Tag</th>
      <th>Position</th>
      <th>Drafted By</th>
      <!-- Pick # column removed -->
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let players = [];
  let currentFilter = "ALL";
  let draftOrder = [];
  let currentPick = 0;
  let teamNames = [];
  let myTeamIndex = -1;

  const fileInput = document.getElementById("fileInput");
  const searchInput = document.getElementById("searchInput");
  const tableBody = document.querySelector("#playerTable tbody");
  const teamCountSelect = document.getElementById("teamCount");
  const yourTeamSelect = document.getElementById("yourTeamSelect");
  const myPickSelect = document.getElementById("myPickIndex");
  const startDraftBtn = document.getElementById("startDraftBtn");
  const currentPickDisplay = document.getElementById("currentPickDisplay");

  function populateTeamCountOptions() {
    const options = [10, 8, 12, 14];
    teamCountSelect.innerHTML = "";
    options.forEach(num => {
      const option = document.createElement("option");
      option.value = num;
      option.textContent = num;
      teamCountSelect.appendChild(option);
    });
  }

  function generateTeamNameInputs() {
    const teamCount = parseInt(teamCountSelect.value, 10);
    const container = document.getElementById("teamNames");
    container.innerHTML = "";
    for (let i = 0; i < teamCount; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.id = `teamName${i}`;
      input.placeholder = `Team ${i + 1}`;
      input.value = teamNames[i] || "";
      input.addEventListener("input", () => {
        teamNames[i] = input.value.trim();
        syncYourTeamSelectOptions();
        saveAll();
      });
      container.appendChild(input);
      container.appendChild(document.createElement("br"));
    }
  }

  function syncYourTeamSelectOptions() {
    const prevValue = yourTeamSelect.value;
    yourTeamSelect.innerHTML = '<option value="" disabled selected>-- Select Team --</option>';
    teamNames = teamNames.map(name => name.trim());
    const teamCount = parseInt(teamCountSelect.value, 10);

    for (let i = 0; i < teamCount; i++) {
      const name = teamNames[i] || "";
      if (name) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = name;
        yourTeamSelect.appendChild(option);
      }
    }

    if (!yourTeamSelect.querySelector(`option[value="${prevValue}"]`)) {
      yourTeamSelect.value = "";
      myTeamIndex = -1;
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
    } else {
      yourTeamSelect.value = prevValue;
      if (prevValue !== "") {
        myTeamIndex = parseInt(prevValue, 10);
        myPickSelect.innerHTML = "";
        const option = document.createElement("option");
        option.value = myTeamIndex + 1;
        option.textContent = myTeamIndex + 1;
        myPickSelect.appendChild(option);
        myPickSelect.value = option.value;
        myPickSelect.disabled = true;
        startDraftBtn.disabled = false;
      }
    }
  }

  yourTeamSelect.addEventListener("change", () => {
    const val = yourTeamSelect.value;
    if (val === "") {
      myTeamIndex = -1;
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
    } else {
      myTeamIndex = parseInt(val, 10);
      myPickSelect.innerHTML = "";
      const option = document.createElement("option");
      option.value = myTeamIndex + 1;
      option.textContent = myTeamIndex + 1;
      myPickSelect.appendChild(option);
      myPickSelect.value = option.value;
      myPickSelect.disabled = true;
      startDraftBtn.disabled = false;
    }
    saveAll();
    renderTable();
  });

  teamCountSelect.addEventListener("change", () => {
    saveAll();
    generateTeamNameInputs();
    syncYourTeamSelectOptions();
  });

  function setupDraft() {
    if (myTeamIndex === -1) {
      alert("Please select your team before starting the draft.");
      return;
    }

    const namesSet = new Set();
    for (const name of teamNames) {
      if (!name) {
        alert("All teams must have a name.");
        return;
      }
      if (namesSet.has(name.toLowerCase())) {
        alert("Team names must be unique.");
        return;
      }
      namesSet.add(name.toLowerCase());
    }

    const teamCount = parseInt(teamCountSelect.value, 10);
    draftOrder = [];
    let forward = true;
    for (let round = 0; round < 20; round++) {
      const roundOrder = Array.from({ length: teamCount }, (_, i) => i);
      draftOrder.push(...(forward ? roundOrder : roundOrder.reverse()));
      forward = !forward;
    }

    if(currentPick >= draftOrder.length) currentPick = 0;

    updateCurrentPickDisplay();
    saveAll();
    renderTable();
  }

  function updateCurrentPickDisplay() {
    if (currentPick >= draftOrder.length) {
      currentPickDisplay.textContent = "Draft Complete!";
      startDraftBtn.disabled = true;
      return;
    }
    const teamIndex = draftOrder[currentPick];
    const teamName = teamNames[teamIndex] || "";
    currentPickDisplay.textContent = `Pick ${currentPick + 1} - ${teamName}`;
  }

  function toggleDrafted(id) {
    const player = players.find(p => p.id === id);
    if (!player) return;

    if (!player.drafted) {
      if (currentPick >= draftOrder.length) {
        alert("All picks completed!");
        return;
      }
      player.drafted = true;
      const teamIndex = draftOrder[currentPick];
      player.draftedBy = teamNames[teamIndex];
      player.pickNumber = currentPick + 1;
      currentPick++;
      broadcastDraftUpdate(player.name);  // Broadcast on new draft pick
    } else {
      if (player.pickNumber === currentPick) {
        player.drafted = false;
        player.draftedBy = null;
        player.pickNumber = null;
        currentPick--;
        broadcastDraftUpdate(player.name, true); // Broadcast undo pick
      } else if (player.pickNumber < currentPick) {
        alert("You can only undo the most recent pick.");
        return;
      }
    }

    updateCurrentPickDisplay();
    saveAll();
    renderTable();
  }

  function broadcastDraftUpdate(playerName, undo = false) {
    // Broadcast the drafted players' names to other tabs/windows
    // We'll send the updated player(s) so others can sync
    if (!syncChannel) return;

    if (undo) {
      // For undo, send the player name to mark as undrafted
      syncChannel.postMessage({ undoPlayer: playerName });
    } else {
      syncChannel.postMessage({ draftedPlayers: [playerName] });
    }
  }

  function saveAll() {
    localStorage.setItem("players", JSON.stringify(players));
    localStorage.setItem("teamNames", JSON.stringify(teamNames));
    localStorage.setItem("draftOrder", JSON.stringify(draftOrder));
    localStorage.setItem("currentPick", currentPick);
    localStorage.setItem("myTeamIndex", myTeamIndex);
    localStorage.setItem("teamCount", teamCountSelect.value);
    localStorage.setItem("yourTeamSelect", yourTeamSelect.value);
  }

  function loadAll() {
    const storedPlayers = localStorage.getItem("players");
    if (storedPlayers) players = JSON.parse(storedPlayers);

    const storedTeamNames = localStorage.getItem("teamNames");
    if (storedTeamNames) teamNames = JSON.parse(storedTeamNames);

    const storedDraftOrder = localStorage.getItem("draftOrder");
    if (storedDraftOrder) draftOrder = JSON.parse(storedDraftOrder);

    const storedCurrentPick = localStorage.getItem("currentPick");
    if (storedCurrentPick) currentPick = parseInt(storedCurrentPick, 10);

    const storedMyTeamIndex = localStorage.getItem("myTeamIndex");
    if (storedMyTeamIndex) myTeamIndex = parseInt(storedMyTeamIndex, 10);

    const storedTeamCount = localStorage.getItem("teamCount");
    if (storedTeamCount) teamCountSelect.value = storedTeamCount;
    else teamCountSelect.value = "10";

    generateTeamNameInputs();

    for (let i = 0; i < teamNames.length; i++) {
      const input = document.getElementById(`teamName${i}`);
      if (input) input.value = teamNames[i] || "";
    }

    syncYourTeamSelectOptions();

    if (myTeamIndex >= 0 && yourTeamSelect.querySelector(`option[value="${myTeamIndex}"]`)) {
      yourTeamSelect.value = myTeamIndex;
      myPickSelect.innerHTML = "";
      const option = document.createElement("option");
      option.value = myTeamIndex + 1;
      option.textContent = myTeamIndex + 1;
      myPickSelect.appendChild(option);
      myPickSelect.value = option.value;
      myPickSelect.disabled = true;
      startDraftBtn.disabled = false;
    } else {
      yourTeamSelect.value = "";
      myTeamIndex = -1;
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
    }
  }

  function filterByPosition(pos) {
    currentFilter = pos;
    renderTable();
  }

  function resetAll() {
    if (!confirm("Are you sure you want to reset everything?")) return;
    players = players.map(p => ({
      ...p,
      drafted: false,
      draftedBy: null,
      pickNumber: null,
    }));
    currentPick = 0;
    draftOrder = [];
    teamNames = [];
    myTeamIndex = -1;
    teamCountSelect.value = "10";
    yourTeamSelect.value = "";
    myPickSelect.innerHTML = "";
    myPickSelect.disabled = true;
    startDraftBtn.disabled = true;
    localStorage.clear();
    generateTeamNameInputs();
    renderTable();
    updateCurrentPickDisplay();
  }

  function renderTable() {
    const keyword = searchInput.value.toLowerCase();
    const hidePicked = document.getElementById("hidePickedCheckbox").checked;
    tableBody.innerHTML = "";
    document.getElementById("myQB").innerHTML = "";
    document.getElementById("myRB").innerHTML = "";
    document.getElementById("myWR").innerHTML = "";
    document.getElementById("myTE").innerHTML = "";

    players.forEach(player => {
      const matchesFilter = currentFilter === "ALL" || player.position === currentFilter;
      const matchesSearch = player.name.toLowerCase().includes(keyword);
      if (!matchesFilter || !matchesSearch) return;

      if (!(hidePicked && player.drafted)) {
        const tr = document.createElement("tr");
        tr.classList.add(player.position);
        if (player.drafted) tr.classList.add("strikethrough");
        if (player.draftedBy === teamNames[myTeamIndex]) tr.classList.add("highlight");
        if (player.pickNumber === currentPick && player.draftedBy !== teamNames[myTeamIndex]) tr.classList.add("recent-pick");

        const nameCell = document.createElement("td");
        nameCell.textContent = player.name;
        if (tr.classList.contains("recent-pick")) {
          const pickNumberBox = document.createElement("span");
          pickNumberBox.className = "pick-number-box";
          pickNumberBox.textContent = `Pick ${player.pickNumber}`;
          nameCell.appendChild(pickNumberBox);

          const pickBadge = document.createElement("span");
          pickBadge.className = "pick-badge";
          pickBadge.textContent = `Pick ${player.pickNumber}`;
          nameCell.appendChild(pickBadge);
        }

        const cbCell = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = player.drafted;
        cb.dataset.id = player.id;
        cb.addEventListener("change", (e) => {
          toggleDrafted(player.id);
        });
        cbCell.appendChild(cb);

        tr.appendChild(cbCell);

        const numCell = document.createElement("td");
        numCell.textContent = player.pickNumber || "";
        numCell.className = "pick-number-cell";
        tr.appendChild(numCell);

        tr.appendChild(nameCell);

        const tagCell = document.createElement("td");
        tagCell.textContent = player.tag || "";
        tr.appendChild(tagCell);

        const posCell = document.createElement("td");
        posCell.textContent = player.position;
        tr.appendChild(posCell);

        const draftedByCell = document.createElement("td");
        draftedByCell.textContent = player.draftedBy || "";
        tr.appendChild(draftedByCell);

        tableBody.appendChild(tr);
      }

      // Add to my picks if matches my team
      if (player.draftedBy === teamNames[myTeamIndex]) {
        const listId = "my" + player.position;
        const ul = document.getElementById(listId);
        if (ul) {
          const li = document.createElement("li");
          li.textContent = player.name;
          ul.appendChild(li);
        }
      }
    });
  }

  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const lines = e.target.result.split(/\r?\n/);
      players = lines
        .filter(line => line.trim() !== "")
        .map((line, index) => {
          const parts = line.split(",");
          return {
            id: index + 1,
            name: parts[0].trim(),
            tag: parts[1]?.trim() || "",
            position: parts[2]?.trim() || "",
            drafted: false,
            draftedBy: null,
            pickNumber: null,
          };
        });
      currentPick = 0;
      draftOrder = [];
      teamNames = [];
      myTeamIndex = -1;
      teamCountSelect.value = "10";
      yourTeamSelect.value = "";
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
      generateTeamNameInputs();
      renderTable();
      updateCurrentPickDisplay();
      saveAll();
    };
    reader.readAsText(file);
  });

  searchInput.addEventListener("input", renderTable);

  // BroadcastChannel for syncing draft picks
  const syncChannel = new BroadcastChannel("espnDraftSync");

  syncChannel.onmessage = (event) => {
    const data = event.data;

    if (data.draftedPlayers) {
      data.draftedPlayers.forEach(name => {
        const player = players.find(p => p.name.toLowerCase() === name.toLowerCase() && !p.drafted);
        if (player) {
          player.drafted = true;
          player.draftedBy = "ESPN";
          player.pickNumber = currentPick + 1;
          currentPick++;
        }
      });
      updateCurrentPickDisplay();
      saveAll();
      renderTable();
    }

    if (data.undoPlayer) {
      const player = players.find(p => p.name.toLowerCase() === data.undoPlayer.toLowerCase());
      if (player && player.drafted) {
        player.drafted = false;
        player.draftedBy = null;
        player.pickNumber = null;
        if(currentPick > 0) currentPick--;
        updateCurrentPickDisplay();
        saveAll();
        renderTable();
      }
    }
  };

  // Initialize the page
  populateTeamCountOptions();
  loadAll();
  renderTable();
  updateCurrentPickDisplay();
  generateTeamNameInputs();

</script>
</body>
</html>
