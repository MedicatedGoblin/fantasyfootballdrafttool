<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantasy Draft Tool</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .controls {
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 8px;
      border: 1px solid black;
      text-align: left;
      vertical-align: middle;
      position: relative;
    }
    .RB { background-color: #c8f7c5; color: black; }
    .WR { background-color: #c5d9f7; color: black; }
    .QB { background-color: #f9d6a5; color: black; }
    .TE { background-color: #e3c5f7; color: black; }
    .strikethrough {
      text-decoration: line-through;
      opacity: 0.5;
      font-weight: bold;
    }
    .highlight {
      background-color: yellow !important;
    }
    .recent-pick {
      border: 3px solid orange;
      background-color: #fff3cd !important;
    }
    /* Pick number box to the right of player name in recent pick row */
    .recent-pick .pick-number-box {
      display: inline-block;
      background: orange;
      color: black;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
      margin-left: 8px;
      vertical-align: middle;
      border: 3px solid orange;
    }
    /* Mobile-friendly pick number badge */
    .pick-badge {
      display: none;
      background: orange;
      color: black;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      margin-left: 8px;
    }
    .my-picks {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
    }
    .my-picks div {
      flex: 1;
      min-width: 150px;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .team-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .pick-label {
      width: 60px;
    }
    @media (max-width: 800px) {
      /* Hide Pick # column on smaller screens */
      th.pick-number-header,
      td.pick-number-cell {
        display: none;
      }
      /* Show pick number badge on player name cell */
      .pick-badge {
        display: inline-block;
      }
      /* Hide the pick-number-box on mobile because space is limited */
      .recent-pick .pick-number-box {
        display: none;
      }
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 14px;
      }
      .controls button, .controls input, .controls select {
        font-size: 14px;
        margin-bottom: 0.5rem;
        width: 100%;
      }
      .controls {
        display: flex;
        flex-direction: column;
      }
      input[type="checkbox"] {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>

<h2>Fantasy Draft Board</h2>

<div class="controls">
  <input type="file" id="fileInput" accept=".txt" />
  <input type="text" id="searchInput" placeholder="Search players..." />
  <button onclick="filterByPosition('ALL')">ALL</button>
  <button onclick="filterByPosition('RB')">RB</button>
  <button onclick="filterByPosition('WR')">WR</button>
  <button onclick="filterByPosition('QB')">QB</button>
  <button onclick="filterByPosition('TE')">TE</button>
  <label><input type="checkbox" id="hidePickedCheckbox" onchange="renderTable()" /> Hide Picked</label>
  <button onclick="resetAll()">Reset All</button>
</div>

<div class="controls">
  <label>Number of Teams:
    <select id="teamCount"></select>
  </label>
  <div id="teamNames"></div>
  <label>Choose Your Team:
    <select id="yourTeamSelect"></select>
  </label>
  <label>Your Team Pick Number:
    <select id="myPickIndex" disabled></select>
  </label>
  <button id="startDraftBtn" onclick="setupDraft()" disabled>Start Draft</button>
  <div id="currentPickDisplay" style="margin-top: 0.5rem;"></div>
</div>

<h3>Your Picks</h3>
<div class="my-picks">
  <div><strong>QB</strong><ul id="myQB"></ul></div>
  <div><strong>RB</strong><ul id="myRB"></ul></div>
  <div><strong>WR</strong><ul id="myWR"></ul></div>
  <div><strong>TE</strong><ul id="myTE"></ul></div>
</div>

<table id="playerTable">
  <thead>
    <tr>
      <th>âœ”</th>
      <th>#</th>
      <th>Name</th>
      <th>Tag</th>
      <th>Position</th>
      <th>Drafted By</th>
      <!-- Removed Pick # header -->
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let players = [];
  let currentFilter = "ALL";
  let draftOrder = [];
  let currentPick = 0;
  let teamNames = [];
  let myTeamIndex = -1;

  const fileInput = document.getElementById("fileInput");
  const searchInput = document.getElementById("searchInput");
  const tableBody = document.querySelector("#playerTable tbody");
  const teamCountSelect = document.getElementById("teamCount");
  const yourTeamSelect = document.getElementById("yourTeamSelect");
  const myPickSelect = document.getElementById("myPickIndex");
  const startDraftBtn = document.getElementById("startDraftBtn");
  const currentPickDisplay = document.getElementById("currentPickDisplay");

  function populateTeamCountOptions() {
    const options = [10, 8, 12, 14];
    teamCountSelect.innerHTML = "";
    options.forEach(num => {
      const option = document.createElement("option");
      option.value = num;
      option.textContent = num;
      teamCountSelect.appendChild(option);
    });
  }

  function generateTeamNameInputs() {
    const teamCount = parseInt(teamCountSelect.value, 10);
    const container = document.getElementById("teamNames");
    container.innerHTML = "";
    for (let i = 0; i < teamCount; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.id = `teamName${i}`;
      input.placeholder = `Team ${i + 1}`;
      input.value = teamNames[i] || "";
      input.addEventListener("input", () => {
        teamNames[i] = input.value.trim();
        syncYourTeamSelectOptions();
        saveAll();
      });
      container.appendChild(input);
      container.appendChild(document.createElement("br"));
    }
  }

  function syncYourTeamSelectOptions() {
    const prevValue = yourTeamSelect.value;
    yourTeamSelect.innerHTML = '<option value="" disabled selected>-- Select Team --</option>';
    teamNames = teamNames.map(name => name.trim());
    const teamCount = parseInt(teamCountSelect.value, 10);

    for (let i = 0; i < teamCount; i++) {
      const name = teamNames[i] || "";
      if (name) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = name;
        yourTeamSelect.appendChild(option);
      }
    }

    // Keep selection if still valid, else reset to blank
    if (!yourTeamSelect.querySelector(`option[value="${prevValue}"]`)) {
      yourTeamSelect.value = "";
      myTeamIndex = -1;
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
    } else {
      yourTeamSelect.value = prevValue;
      if (prevValue !== "") {
        myTeamIndex = parseInt(prevValue, 10);
        myPickSelect.innerHTML = "";
        const option = document.createElement("option");
        option.value = myTeamIndex + 1;
        option.textContent = myTeamIndex + 1;
        myPickSelect.appendChild(option);
        myPickSelect.value = option.value;
        myPickSelect.disabled = true;
        startDraftBtn.disabled = false;
      }
    }
  }

  function setupDraft() {
    if (myTeamIndex === -1) {
      alert("Please select your team before starting the draft.");
      return;
    }

    const namesSet = new Set();
    for (const name of teamNames) {
      if (!name) {
        alert("All teams must have a name.");
        return;
      }
      if (namesSet.has(name.toLowerCase())) {
        alert("Team names must be unique.");
        return;
      }
      namesSet.add(name.toLowerCase());
    }

    const teamCount = parseInt(teamCountSelect.value, 10);
    draftOrder = [];
    let forward = true;
    for (let round = 0; round < 20; round++) {
      const roundOrder = Array.from({ length: teamCount }, (_, i) => i);
      draftOrder.push(...(forward ? roundOrder : roundOrder.reverse()));
      forward = !forward;
    }
    currentPick = 0;

    updateCurrentPickDisplay();
    saveAll();
    renderTable();
  }

  function updateCurrentPickDisplay() {
    if (currentPick >= draftOrder.length) {
      currentPickDisplay.textContent = "Draft Complete!";
      startDraftBtn.disabled = true;
      return;
    }
    const teamIndex = draftOrder[currentPick];
    const teamName = teamNames[teamIndex] || "";
    currentPickDisplay.textContent = `Pick ${currentPick + 1} - ${teamName}`;
  }

  function toggleDrafted(id) {
    const player = players.find(p => p.id === id);
    if (!player) return;

    if (!player.drafted) {
      if (currentPick >= draftOrder.length) {
        alert("All picks completed!");
        return;
      }
      player.drafted = true;
      const teamIndex = draftOrder[currentPick];
      player.draftedBy = teamNames[teamIndex];
      player.pickNumber = currentPick + 1;
      currentPick++;
    } else {
      if (player.pickNumber === currentPick) {
        player.drafted = false;
        player.draftedBy = null;
        player.pickNumber = null;
        currentPick--;
      } else if (player.pickNumber < currentPick) {
        alert("You can only undo the most recent pick.");
        return;
      }
    }

    updateCurrentPickDisplay();
    saveAll();
    renderTable();
  }

  function saveAll() {
    localStorage.setItem("players", JSON.stringify(players));
    localStorage.setItem("teamNames", JSON.stringify(teamNames));
    localStorage.setItem("draftOrder", JSON.stringify(draftOrder));
    localStorage.setItem("currentPick", currentPick);
    localStorage.setItem("myTeamIndex", myTeamIndex);
    localStorage.setItem("teamCount", teamCountSelect.value);
    localStorage.setItem("yourTeamSelect", yourTeamSelect.value);
  }

  function loadAll() {
    const storedPlayers = localStorage.getItem("players");
    if (storedPlayers) players = JSON.parse(storedPlayers);

    const storedTeamNames = localStorage.getItem("teamNames");
    if (storedTeamNames) teamNames = JSON.parse(storedTeamNames);

    const storedDraftOrder = localStorage.getItem("draftOrder");
    if (storedDraftOrder) draftOrder = JSON.parse(storedDraftOrder);

    const storedCurrentPick = localStorage.getItem("currentPick");
    if (storedCurrentPick) currentPick = parseInt(storedCurrentPick, 10);

    const storedMyTeamIndex = localStorage.getItem("myTeamIndex");
    if (storedMyTeamIndex) myTeamIndex = parseInt(storedMyTeamIndex, 10);

    const storedTeamCount = localStorage.getItem("teamCount");
    if (storedTeamCount) teamCountSelect.value = storedTeamCount;
    else teamCountSelect.value = "10";

    generateTeamNameInputs();

    for (let i = 0; i < teamNames.length; i++) {
      const input = document.getElementById(`teamName${i}`);
      if (input) input.value = teamNames[i] || "";
    }

    syncYourTeamSelectOptions();

    if (myTeamIndex >= 0 && yourTeamSelect.querySelector(`option[value="${myTeamIndex}"]`)) {
      yourTeamSelect.value = myTeamIndex;
      myPickSelect.innerHTML = "";
      const option = document.createElement("option");
      option.value = myTeamIndex + 1;
      option.textContent = myTeamIndex + 1;
      myPickSelect.appendChild(option);
      myPickSelect.value = option.value;
      myPickSelect.disabled = true;
      startDraftBtn.disabled = false;
    } else {
      yourTeamSelect.value = "";
      myTeamIndex = -1;
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
    }
  }

  function filterByPosition(pos) {
    currentFilter = pos;
    renderTable();
  }

  function resetAll() {
    if (!confirm("Are you sure you want to reset everything?")) return;
    players = players.map(p => ({
      ...p,
      drafted: false,
      draftedBy: null,
      pickNumber: null,
    }));
    currentPick = 0;
    draftOrder = [];
    teamNames = [];
    myTeamIndex = -1;
    teamCountSelect.value = "10";
    yourTeamSelect.value = "";
    myPickSelect.innerHTML = "";
    myPickSelect.disabled = true;
    startDraftBtn.disabled = true;
    localStorage.clear();
    generateTeamNameInputs();
    renderTable();
    updateCurrentPickDisplay();
  }

  function renderTable() {
    const keyword = searchInput.value.toLowerCase();
    const hidePicked = document.getElementById("hidePickedCheckbox").checked;
    tableBody.innerHTML = "";
    document.getElementById("myQB").innerHTML = "";
    document.getElementById("myRB").innerHTML = "";
    document.getElementById("myWR").innerHTML = "";
    document.getElementById("myTE").innerHTML = "";

    players.forEach(player => {
      const matchesFilter = currentFilter === "ALL" || player.position === currentFilter;
      const matchesSearch = player.name.toLowerCase().includes(keyword);
      if (!matchesFilter || !matchesSearch) return;

      if (!(hidePicked && player.drafted)) {
        const tr = document.createElement("tr");
        tr.classList.add(player.position);
        if (player.drafted) tr.classList.add("strikethrough");
        if (player.draftedBy === teamNames[myTeamIndex]) tr.classList.add("highlight");
        if (player.pickNumber === currentPick && player.draftedBy !== teamNames[myTeamIndex]) tr.classList.add("recent-pick");

        // Construct player name cell with pick badge for mobile and pick number box for desktop
        const nameCell = document.createElement("td");
        nameCell.innerHTML = `${player.name}`;
        if (tr.classList.contains("recent-pick") && player.pickNumber) {
          const pickBox = document.createElement("div");
          pickBox.className = "pick-number-box";
          pickBox.textContent = `Pick ${player.pickNumber}`;
          nameCell.appendChild(pickBox);
        } else if (player.pickNumber) {
          // For non-recent picks, show small badge on mobile
          const pickBadge = document.createElement("span");
          pickBadge.className = "pick-badge";
          pickBadge.textContent = `#${player.pickNumber}`;
          nameCell.appendChild(pickBadge);
        }

        tr.innerHTML = `
          <td><input type="checkbox" ${player.drafted ? "checked" : ""} onchange="toggleDrafted(${player.id})" /></td>
          <td>${player.id}</td>
        `;
        tr.appendChild(nameCell);
        tr.innerHTML += `
          <td>${player.tag}</td>
          <td>${player.position}</td>
          <td>${player.draftedBy || ""}</td>
        `;

        tr.addEventListener("dblclick", () => toggleDrafted(player.id));
        tableBody.appendChild(tr);
      }

      if (player.draftedBy === teamNames[myTeamIndex]) {
        const li = document.createElement("li");
        li.textContent = `${player.name} (${player.tag})`;
        document.getElementById("my" + player.position).appendChild(li);
      }
    });
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      const lines = e.target.result.split("\n").filter(line => line.trim());
      players = lines.map((line, index) => {
        const match = line.match(/^(.*?)\s+([A-Z]{2,3}\d+)$/);
        if (!match) return null;
        const name = match[1];
        const tag = match[2];
        const positionMatch = tag.match(/[A-Z]+/);
        const position = positionMatch ? positionMatch[0] : "";
        return {
          id: index + 1,
          name,
          tag,
          position,
          drafted: false,
          draftedBy: null,
          pickNumber: null,
        };
      }).filter(p => p !== null);
      saveAll();
      renderTable();
    };
    reader.readAsText(file);
  }

  function syncMyPickIndex() {
    if (yourTeamSelect.value === "") {
      myPickSelect.innerHTML = "";
      myPickSelect.disabled = true;
      startDraftBtn.disabled = true;
      myTeamIndex = -1;
      saveAll();
      return;
    }
    myTeamIndex = parseInt(yourTeamSelect.value, 10);
    myPickSelect.innerHTML = "";
    const option = document.createElement("option");
    option.value = myTeamIndex + 1;
    option.textContent = myTeamIndex + 1;
    myPickSelect.appendChild(option);
    myPickSelect.value = option.value;
    myPickSelect.disabled = true;
    startDraftBtn.disabled = false;
    saveAll();
  }

  fileInput.addEventListener("change", handleFileUpload);
  searchInput.addEventListener("input", renderTable);
  teamCountSelect.addEventListener("change", () => {
    generateTeamNameInputs();
    saveAll();
  });
  yourTeamSelect.addEventListener("change", syncMyPickIndex);

  // Initial setup
  window.onload = () => {
    populateTeamCountOptions();
    loadAll();
    renderTable();
    updateCurrentPickDisplay();
  };
</script>

</body>
</html>
